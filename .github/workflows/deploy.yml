# Deploy to GitHub Pages
name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ['Test', 'E2E Tests']
    types:
      - completed
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  check-workflows:
    runs-on: ubuntu-latest
    # Skip check for manual dispatch
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check if both workflows passed
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // For manual dispatch, always deploy
            if (context.eventName === 'workflow_dispatch') {
              core.setOutput('should_deploy', 'true');
              return;
            }

            // Get the latest workflow runs for both required workflows
            const workflows = ['Test', 'E2E Tests'];
            const branch = context.payload.workflow_run?.head_branch || 'main';

            let allPassed = true;
            for (const workflowName of workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowName === 'Test' ? 'test.yml' : 'e2e-tests.yml',
                branch: branch,
                per_page: 1,
                status: 'completed'
              });

              if (runs.data.workflow_runs.length === 0) {
                console.log(`No completed runs found for ${workflowName}`);
                allPassed = false;
                break;
              }

              const latestRun = runs.data.workflow_runs[0];
              console.log(`${workflowName}: ${latestRun.conclusion} (${latestRun.head_sha.substring(0, 7)})`);

              if (latestRun.conclusion !== 'success') {
                allPassed = false;
                break;
              }

              // Verify the run is for the same commit
              if (latestRun.head_sha !== context.payload.workflow_run.head_sha) {
                console.log(`${workflowName} latest run is for different commit`);
                allPassed = false;
                break;
              }
            }

            core.setOutput('should_deploy', allPassed ? 'true' : 'false');
            console.log(`Should deploy: ${allPassed}`);

  build:
    needs: check-workflows
    if: needs.check-workflows.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_GA_MEASUREMENT_ID: ${{ secrets.VITE_GA_MEASUREMENT_ID }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [check-workflows, build]
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
