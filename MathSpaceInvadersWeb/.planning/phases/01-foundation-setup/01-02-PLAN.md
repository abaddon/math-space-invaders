---
phase: 01-foundation-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - e2e/support/fixtures.ts
  - e2e/support/hooks.ts
  - playwright.config.ts
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Browser launches when running e2e tests"
    - "Browser closes after test completion"
    - "Screenshot is captured when a test fails"
    - "Screenshot is saved to test-results/ with scenario name"
    - "test-results/ is cleaned before each run"
    - "Developer can run npm run test:e2e and see test execute"
  artifacts:
    - path: "e2e/support/hooks.ts"
      provides: "Before/After hooks for browser lifecycle"
      contains: "Before"
    - path: ".gitignore"
      provides: "Ignores generated test files and artifacts"
      contains: ".features-gen"
  key_links:
    - from: "e2e/support/hooks.ts"
      to: "playwright.config.ts"
      via: "require path in defineBddConfig"
      pattern: "support.*\\.ts"
    - from: "e2e/support/fixtures.ts"
      to: "e2e/features/**/*.ts"
      via: "import { Given, When, Then }"
      pattern: "import.*fixtures"
---

<objective>
Implement Custom World pattern with Playwright fixtures, configure Before/After hooks for browser lifecycle management, and verify the complete E2E infrastructure with a passing smoke test.

Purpose: Complete the testing infrastructure so that tests can manage browser state, capture failures, and produce reports.
Output: Working E2E test that runs with `npm run test:e2e`, launches browser, captures screenshots on failure, and generates HTML report.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-setup/01-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement hooks and enhance fixtures</name>
  <files>
    - e2e/support/hooks.ts
    - e2e/support/fixtures.ts
  </files>
  <action>
    1. Create e2e/support/hooks.ts with Before/After hooks:
       ```typescript
       import { Before, After, BeforeAll, AfterAll } from 'playwright-bdd';
       import fs from 'fs';
       import path from 'path';

       // Clean test-results directory before test run
       BeforeAll(async () => {
         const testResultsDir = path.join(process.cwd(), 'test-results');
         if (fs.existsSync(testResultsDir)) {
           fs.rmSync(testResultsDir, { recursive: true, force: true });
         }
         fs.mkdirSync(testResultsDir, { recursive: true });
         console.log('E2E test suite starting...');
       });

       // Log scenario start
       Before(async ({ $testInfo }) => {
         console.log(`Starting: ${$testInfo.title}`);
       });

       // Screenshot on failure with scenario-based naming
       After(async ({ page, $testInfo }) => {
         if ($testInfo.status === 'failed') {
           const screenshotName = $testInfo.title
             .toLowerCase()
             .replace(/[^a-z0-9]+/g, '-')
             .replace(/^-|-$/g, '');

           const screenshotPath = path.join(
             'test-results',
             `${screenshotName}-FAILED.png`
           );

           await page.screenshot({ path: screenshotPath, fullPage: true });
           console.log(`Screenshot saved: ${screenshotPath}`);
         }
       });

       AfterAll(async () => {
         console.log('E2E test suite complete.');
       });
       ```

    2. Update e2e/support/fixtures.ts to include test info access:
       ```typescript
       import { createBdd } from 'playwright-bdd';
       import { test as base } from '@playwright/test';

       // Extend base test with custom fixtures if needed
       export const test = base;

       // Create BDD functions
       export const { Given, When, Then } = createBdd(test);
       ```

    Note per 01-CONTEXT.md:
    - Screenshots named by scenario (kebab-case + "-FAILED")
    - No video capture
    - Clean test-results/ before each run
  </action>
  <verify>
    - `cat e2e/support/hooks.ts` shows BeforeAll, Before, After, AfterAll hooks
    - `cat e2e/support/fixtures.ts` shows createBdd with test parameter
    - `npx tsc --noEmit -p e2e/tsconfig.json` compiles without errors
  </verify>
  <done>Hooks implemented with screenshot-on-failure and test-results cleanup</done>
</task>

<task type="auto">
  <name>Task 2: Update gitignore and verify configuration</name>
  <files>
    - .gitignore
    - playwright.config.ts
  </files>
  <action>
    1. Add E2E-related entries to .gitignore:
       ```
       # E2E Testing
       .features-gen/
       test-results/
       playwright-report/
       playwright/.cache/
       ```

    2. Verify playwright.config.ts includes hooks in require paths (should already be covered by 'e2e/support/**/*.ts' pattern from Plan 01).

    3. Optionally enhance playwright.config.ts reporter section for better output per 01-CONTEXT.md:
       ```typescript
       reporter: [
         ['line', { printSteps: false }],  // Minimal verbosity
         ['html', { open: 'always', outputFolder: 'playwright-report' }],
       ],
       ```

    Note: The 'line' reporter with minimal output matches "Minimal verbosity - only show failures and final summary" from CONTEXT.md.
  </action>
  <verify>
    - `grep -q ".features-gen" .gitignore` returns 0 (entry exists)
    - `grep -q "test-results" .gitignore` returns 0 (entry exists)
    - `grep -q "playwright-report" .gitignore` returns 0 (entry exists)
  </verify>
  <done>Gitignore updated with E2E artifacts, configuration verified</done>
</task>

<task type="auto">
  <name>Task 3: Run smoke test and verify complete infrastructure</name>
  <files>
    (no new files - verification task)
  </files>
  <action>
    1. Ensure dev server can start (needed for webServer config):
       ```bash
       # Quick check that dev works
       npm run dev &
       DEV_PID=$!
       sleep 5
       curl -s http://localhost:5173 > /dev/null && echo "Dev server OK"
       kill $DEV_PID
       ```

    2. Run the full E2E test command:
       ```bash
       npm run test:e2e
       ```

    3. Verify expected outputs:
       - Console shows test execution
       - HTML report opens in browser (or check playwright-report/ exists)
       - .features-gen/ contains generated spec file
       - test-results/ directory exists (may be empty if test passed)

    4. Test screenshot-on-failure by temporarily breaking the smoke test:
       - Modify smoke.feature or steps.ts to expect something that fails
       - Run `npm run test:e2e`
       - Verify screenshot appears in test-results/ with scenario name
       - Revert the change

    If tests fail for infrastructure reasons (not the intentional failure test), debug and fix configuration.
  </action>
  <verify>
    - `npm run test:e2e` exits with code 0 (or expected failure for screenshot test)
    - `ls playwright-report/` shows index.html
    - `ls .features-gen/` shows generated smoke test file
    - Screenshot test: `ls test-results/*FAILED.png` shows file when test fails
  </verify>
  <done>Smoke test passes, HTML report generates, screenshot-on-failure works</done>
</task>

</tasks>

<verification>
Complete infrastructure verification checklist:

1. **Browser lifecycle:**
   ```bash
   npm run test:e2e:headed
   ```
   Visual confirmation: Browser opens, navigates, closes

2. **Test generation:**
   ```bash
   ls -la .features-gen/
   ```
   Expected: smoke.feature.spec.ts or similar generated file

3. **HTML report:**
   ```bash
   ls -la playwright-report/
   ```
   Expected: index.html and associated assets

4. **Screenshot on failure (optional verification):**
   Temporarily modify smoke test to fail, run, check test-results/ for screenshot

5. **All Phase 1 requirements satisfied:**
   - INFRA-01: Playwright Installation (Plan 01)
   - INFRA-02: Directory Structure (Plan 01)
   - INFRA-03: Cucumber Configuration (Plan 01 - via playwright-bdd)
   - INFRA-04: Playwright Configuration (Plan 01)
   - INFRA-08: Custom World (This plan - via fixtures.ts)
   - INFRA-09: Hooks Configuration (This plan - via hooks.ts)
</verification>

<success_criteria>
1. `npm run test:e2e` executes successfully
2. Browser launches (visible in headed mode) and closes after test
3. BeforeAll hook cleans test-results/ directory
4. After hook captures screenshot on test failure with scenario-based filename
5. HTML report generated in playwright-report/ and opens automatically
6. .features-gen/ contains generated test files from Gherkin
7. .gitignore includes .features-gen/, test-results/, playwright-report/
8. All Phase 1 success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-02-SUMMARY.md`
</output>
